#summary System Feature - Purchase System

= Overview =
The Purchase System manages all the purchase systems and handles player and logic communication between making purchases and altering the attributes of each purchasable item

Purchasing holds vital importance in Command & Conquer Mode. It allows a player to upgrade their character class, obtain new weapons, vehicles and items, and replenish their ammo and health counts. Loosely, the contents in the purchase menu are filled when the level is loaded, but can be added to manually during the duration of the game. The contents are updated on the server and can be changed based on the status of buildings during the game. Clients can request the contents of the purchase menu and make purchases which are approved and handled by the server.

= Functionality =
Below are the methods to be defined in the IPurchaseSystem interface.

=== Reset ===
Purpose:
Resets the system by cleaning out any purchase entries held by any teams.

Arguments:
void

Returns:
void

=== !LoadConfigForTeam ===
Purpose:
Loads in the Purchase Sections and Items for the specified team from the passed-in XML section.

Arguments:
 * nTeam - Team ID that owns these purchase items
 * pXMLNode - XML Node that represents the root <Purchases> where sections and items are defined in.

Returns: 
TRUE if the config was loaded correctly, FALSE otherwise.

=== !DefineManualItem ===
Purpose:
Adds a manual Purchase Item to the given Section for the given team.
 * nTeam - Team ID that owns the Purchase Section.
 * szSection - Name of the Purchase Section that should house the Item.
 * tItem - Purchase Item to add. (See tPurchaseItem sub module)

= Sub Modules =

=== !tPurchaseSection ===
Description: Structure used to describe a Purchase Section.

Member Variables:
 * m_nTeam - Team ID that owns it
 * m_szName - Section name
 * m_pItemRoot - Root of Purchase Item list.

=== !tPurchaseItem ===
Description: Structure used to describe a Purchase Item.

Member Variables:
 * m_pNext - Next Purchase Item in the list.
 * m_szName - Name of the Purchase Item.
 * m_szDesc - Description of the Purchase Item.
 * m_nCost - Cost of the item.
 * m_ucFlags - Purchase Item flags. (See PURCHASE_FLAG)
 * m_Item = Item purchased (based on type)
 * m_szImageEnabled - 2D texture used when enabled
 * m_szImageDisabled - 2D texture used when disabled
 * m_Prerequisite - Map of prerequisites (See tPrerequisite)

Flags: PURCHASE_FLAG section:
 * PURCHASE_FLAG_ENABLED - Bit used to mark if purchase item is enabled
 * PURCHASE_FLAG_HIDDEN - Bit used to mark if purchase item is hidden.
 * PURCHASE_FLAG_TYPE_SOLDIER - Bit combination used to mark if purchase item is of type Soldier.
 * PURCHASE_FLAG_TYPE_VEHICLE - Bit combination used to mark if purchase item is of type Vehicle.
 * PURCHASE_FLAG_TYPE_WEAPON - Bit combination used to mark if purchase item is of type Weapon.
 * PURCHASE_FLAG_TYPE_REFILL - Bit combination used to mark if purchase item is of type Refill.

=== tPrerequisite ===
Description: Structure used to describe a prerequisite for a Purchase Item.

Member Variables:
 * m_szClass - Building class name
 * m_bDisableOnDeath - TRUE if the item should be disabled on building death.
 * m_bDisableOnPowerDown - TRUE if the item should be disabled on power down.
 * m_nCostDeduction - Amount of money taken off Item cost if building is functioning.

= Terminology =
== Purchase Items ==
Purchasable items are the physical objects a player can purchase from the Purchase Menu. These items have specific attributes tied to them. Purchasable items can be loaded in by one of two ways: 1. Through the !LoadConfigForTeam which pulls them out of an XML file, or 2. Through the !DefineManualItem which adds a single entry into the given section for the given team. Each Purchase Item belongs to a Purchase Section. Each Purchase Section belongs to a team. Only the team that owns the Purchase Section can view its contents and request purchases from it.

Purchase Items have the following attributes assigned to them:
 * Name = Literal name representation of the item.
 * Description = Literal description of the item.
 * Enabled = Boolean flag used to mark if it is enabled (can be purchased) or disabled (cannot be purchased).
 * Hidden = Boolean flag used to mark if it is hidden in the purchase menu.
 * Cost = Base value (in credits) for the purchase item.
 * Type = Purchase Item type, i.e. Soldier, Vehicle, Weapon, Refill.
 * Item = Data bought. Dependant on its type.
 * !ImageEnabled = 2D texture image used to represent the item in the Purchase Menu when the item is enabled.
 * !ImageDisabled = 2D texture image used to represent the item in the Purchase Menu when the item is disabled.
 * Prerequisites = List of buildings that can directly affect the attributes of the item based on the current status of each. 

== Purchase Sections ==
Sections contain multiple items. Purchase Terminals are assigned a section. Spawn points and EVA devices can also be assigned Purchase Sections, enabling a player to make a purchase when they are spawning and at any point in the game through their EVA device.

== Purchase Terminal ==
The terminal is a physical item which players can access and use to view the contents of the Purchase Section bound to it, and request purchases from it. Terminals can be destroyed (repaired by an Engineer) or shut down through building events such as loss of power or destruction.

== Purchase Menu ==
The Purchase Menu is the UI the player interfaces with to make purchases through the system. The Menu displays all visible items in the opened section. Players can click on each item or use hotkeys to request purchases for each item or view the description. Player can also make bundles to quickly purchase more than one item at a time.

= XML Definition =
The following is a template exert from a team script which defines the purchase sections and items that team can make.
{{{
<Purchases>
  <Section Name="Classes">
    <Entry Name="Minigunner" Description="A basic Minigunner with a machine gun."
Cost="200" Hidden="0" Enabled="1" Type="Soldier" Item="SOLDIER_MINIGUNNER"
ImageEnabled="Textures/PM/Item/MiniGunner.tga"
ImageDisabled="Textures/PM/Item/Minigunner_Disabled.tga">
      <Prerequisites>
        <Prerequisite Building="SoldierFactory" DisableOnDeath="1" DisableOnPower="0"
CostDeduction="100" />
      </Prerequisites>
    </Entry>
  </Section>
</Purchases>
}}}

The *Purchases* tag wraps around all defined Purchase Sections. This tag is the node that is passed in to the !LoadConfigForTeam function.

Defined within are *Section* tags, each of which describes a Purchase Section. The _Name_ attribute is the name given to the Purchase Section and is used to determine which section is used by a Purchase Terminal.

Defined with each Section tag are *Entry* tags, each of which describe a Purchase Item. The attributes defined are used to describe the item. The *Prerequisites* tag is used to define the prerequisites for the Purchase Item.

Each *Prerequisite* tag houses attributes that describe the prerequisite:
 * Building = The Building Class that is this prerequisite.
 * !DisableOnDeath = Set to '1' to disable the purchase entry when this building is destroyed.
 * !DisableOnPower = Set to '1' to disable the purchase entry when this building is powered down.
 * !CostDeduction = Amount of money taken off the cost when this building is functioning with power. If it is destroyed or powered down, and the entry is not disabled, the amount will be added back on to the cost. Given our example, the Minigunner will cost 100 credits as long as the Soldier Factory remains powered. If it loses power, it will go back to 200 credits, the initial cost. If it is destroyed, the Minigunner will no longer be purchasable.

[TechDoc_Architecture Back]






